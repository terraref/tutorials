---
title: "How to upload metadata to BETY"
output: html_document
---

# Section 1: Overview

The objective of this tutorial is to demonstrate how to upload a season's metadata to the traits database. 

Each season should have metadata for experiments, sites, treatments, cultivars, and citations.

For this tutorial, data will be uploaded to a local instance of a test database. Instructions on how to set up a local instance of a test database can be found below in section 2.

## Inputs:

* URL to a public published google sheet
  * copy and fill out the following [google sheets template](https://docs.google.com/spreadsheets/d/1Fr_8xYOucyCQ9WH5_1bfPTMpm3IhKX5oqW4UOMvPoSY/edit#gid=0).
  * make the google sheet public (to anyone with link) and publish to the web.
  * Instructions on how to fill out the template can be found under the README worksheet.
* Database connection parameters 
  * save in a .pgpass file in the home directory
  * see more information on how to create this file below in section 3.

# Section 2: Setting up local instance of test database

## Install Docker

To run a local instance of the BETY test database, you will need to have Docker installed on your computer. 

Visit [https://www.docker.com/](https://www.docker.com/) to download Docker for MAC or Windows. You will need to create a docker account.

## Clone bety github repository

In a directory of your choice, clone the bety repository from github:

`git clone git@github.com:pecanproject/bety`

Then cd to the bety directory:

`cd bety`

## Start up and run docker container

Mount postgres container to port 5432 in docker-compose.override file:

`wget https://gist.githubusercontent.com/dlebauer/a2cd7fec09280e5a01e208e91806694f/raw/7fd122055c1c7995ac2d606ec67b25402d2ae9de/docker-compose.override.yml`

Start postgres:

`docker-compose -p bety up -d postgres`

Initialize BETY database:

`docker run -ti --rm --network bety_bety -e BETY_INITIALIZE_URL='-w https://terraref.ncsa.illinois.edu/bety/dump/bety0/bety.tar.gz' pecan/bety:terra initialize`

Sync with server 6 only:

`docker run -ti --rm --network bety_bety -e REMOTE_SERVERS='6' pecan/bety:terra sync`

Bring up full stack:

`docker-compose up`

# Section 3: Setting up .pgpass file

A .pgpass file will be used to pass in database connection parameters to the BETY test database.

In your home directory, create a `.pgpass` file and change the permissions to 600.

```sh
touch ~/.pgpass
chmod 0600 ~/.pgpass
```

On a new line, enter the database connection parameters for the local instance of the BETY test database in the format:  

`host:port:database:username:password`

# Section 4: Set up for metadata upload

**YOU WILL NEED TO UPDATE DATABASE CONNECTION PARAMETERS IN THIS SECTION ON LINES 112-115**
**YOU WILL NEED TO PASS IN THE URL TO YOUR GOOGLE SHEET IN THIS SECTION ON LINE 127**

## Load in packages

```{r load-pack}

# load in packages
library(RPostgres)
library(readxl)
library(dplyr)
library(googlesheets)

```

## Set options

```{r set-option}

options(scipen = 999)

```

## Connect to database; Provide connection parameters here (REQUIRED)

_Please make sure the following database connection parameters (lines 112-115) match those that you have inputted in your .pgpass file. Make any needed changes._

```{r create-dbcon}

# create database connection using parameters in .pgpass file
dbcon <- dbConnect(RPostgres::Postgres(),
                   dbname = 'bety',
                   host = 'localhost',
                   user = 'bety',
                   port = 5432)

```

## Provide URL to google sheet here (REQUIRED)

```{r user-url}

# please provide URL to google sheet below on line 127
# a sample URL has been provided for google sheet containing MAC season 8 metadata
# please replace sample URL with your own

url <- 'https://docs.google.com/spreadsheets/d/1c_5j7q3TO6gQ24KSopE-_LXA5HhfsUEqMupckGZAbo8/edit#gid=606795573' 

```

Use URL provided by user to read directly from google sheets

```{r read-gs}

# get key from URL
key <- extract_key_from_url(url)

# register sheet 
gs_obj <- key %>% gs_key(lookup = FALSE)

## users sheet
users <- gs_obj %>% gs_read(ws = 'users')

## experiments sheet
experiments <- gs_obj %>% gs_read(ws = 'experiments')

## sites sheet
sites <- gs_obj %>% gs_read(ws = 'sites')

## treatments sheet
treatments <- gs_obj %>% gs_read(ws = 'treatments')

## cultivars sheet
cultivars <- gs_obj %>% gs_read(ws = 'cultivars')

## citations sheet
citations <- gs_obj %>% gs_read(ws = 'citations')


```

## Reformat of data / Field Additions to Google Sheets 

```{r reformat}

###########################################
## change format of experiments$start_date, experiments$end_date to date (yyyy-mm-dd)
experiments$start_date <- as.Date(experiments$start_date)
experiments$end_date <- as.Date(experiments$end_date)

```

Get bety user id from user login

```{r get-user-id}

## get login from 'users' sheet
user_login <- users$login

## reference bety users table
users_bety <- tbl(dbcon,
                  'users')

## get user id
user_id <- users_bety %>%
  filter(login == user_login) %>% 
  select(id) %>% collect

## add user id field to experiments 
experiments$user_id <- rep(user_id$id, 
                           nrow(experiments))

```

Next: Add new experiments, sites, treatments, cultivars, and citations to BETY.

New additions will be added using parameterized queries. 

The following function, `getParamQuery`, can be used to generate a list that contains a parameterized query and set of corresponding parameter values for a row of (experiments|sites|treatments|cultivars|citations)

`getParamQuery` should be run on each row of (experiments|sites|treatments|cultivars|citations) 

```{r getParamQuery-function}

getParamQuery <- function(row, tbl_name, tbl_cols){
  complete_field <- names(row)[which(!is.na(row))] 
  complete_field_table <- complete_field[complete_field %in% tbl_cols]
  position_params <- sapply(1:length(complete_field_table),
                            function(x) paste0('$', x))
  sql_insert <- paste0("insert into ",
                       tbl_name,
                       " (",
                       paste(complete_field_table,
                             collapse = ', '),
                       ") ",
                       "values (",
                       paste(position_params,
                             collapse = ', '),
                       ")")
  param_vals <- as.list(row[complete_field_table])
  return(list(sql_insert = sql_insert,
              param_vals = param_vals))
}

```

Use the `addBety` function to insert new experiments, sites, treatments, cultivars, or citations into BETY. 

The input of `addBety` should be a list containing all parameterized queries and corresponding parameter values for all new experiments, sites, treatments, cultivars, or citations. This list can be generated by running `getParamQuery` on each row of (experiments|sites|treatments|cultivars|citations) using `apply`. See below for more detail. 

```{r addBety-function}

addBety <- function(query_val_list){
  for(i in 1:length(query_val_list)){
    tryCatch({
      dbBegin(dbcon)
      send <- dbSendStatement(dbcon,
                              query_val_list[[i]]$sql_insert,
                              params = unname(query_val_list[[i]]$param_vals))
      row_affect <- dbGetRowsAffected(send)
      dbClearResult(send)
      ifelse(row_affect == 1, dbCommit(dbcon), dbRollback(dbcon))
    }, error = function(cond){
      dbRollback(dbcon)
      print(paste0('Error: ', cond))
      print('... Rollback')
    })
  }
}

```

Add new experiments using `getParamQuery` and `addBety`

```{r add-new-exp}

## column names of experiments table in bety # will be passed into getParamQuery
exp_cols <- c('name',
              'start_date',
              'end_date',
              'description',
              'design',
              'user_id')

## run getParamQuery on each row of experiments  
exp_query_val <- apply(experiments,
                       1,
                       getParamQuery,
                       tbl_name = 'experiments',
                       tbl_cols = exp_cols)

## run addBety to add new experiments # pass in exp_query_val generated above
addBety(exp_query_val)
```

Add new sites using `getParamQuery` and `addBety`

```{r add-new-sites}

#column names of sites table in bety
sites_cols <- c('sitename',
                'city',
                'state',
                'country',
                'notes',
                'greenhouse',
                'geometry',
                'time_zone')

## run getParamQuery on each row of sites 
sites_query_val <- apply(sites[1:2, ],
                         1,
                         getParamQuery,
                         tbl_name = 'sites',
                         tbl_cols = sites_cols)

## run addBety to add new sites # pass in sites_query_val generated above
addBety(sites_query_val)
```

Add new treatments using `getParamQuery` and `addBety`

```{r add-new-treat}

#column names of treatments table in bety
treat_cols <- c('name',
                'definition',
                'control')

## run getParamQuery on each row of treatments 
treat_query_val <- apply(treatments,
                         1,
                         getParamQuery,
                         tbl_name = 'treatments',
                         tbl_cols = treat_cols)

## run addBety to add new treatments # pass in treat_query_val generated above
addBety(treat_query_val)
```

Add new cultivars using `getParamQuery` and `addBety`

```{r add-new-cultivar}

## refer to bety species table to get id from species name 
species_bety <- tbl(dbcon,
                    "species")

## get unique species from cultivars sheet
unq_species <- unique(cultivars$species)

spp_id <- species_bety %>%
  filter(scientificname == unq_species) %>%
  select(id) %>%
  collect()
  
## create specie_id column in cultivars 
cultivars$specie_id <- rep(spp_id$id,
                           nrow(cultivars))

## create specie_id column in sites as well
## (will use later for associating sites with cultivars)
sites$specie_id <- rep(spp_id$id,
                       nrow(sites))

#subset cultivars to only contain name and specie_id combinations not yet present in BETY
cultivars_bety <- tbl(dbcon,
                      "cultivars")

cultivars_bety_sub <- cultivars_bety %>%
  select(name, specie_id) %>%
  collect()

cultivars_new <- anti_join(cultivars, 
                           cultivars_bety_sub,
                           by = c('name', 'specie_id'))

#column names of cultivars table in bety
cultivar_cols <- c('specie_id',
                'name',
                'ecotype',
                'notes')

## run getParamQuery on each row of cultivars 
cultivar_query_val <- apply(cultivars_new[1, ],
                            1,
                            getParamQuery,
                            tbl_name = 'cultivars',
                            tbl_cols = cultivar_cols)

## run addBety to add new cultivars # pass in cultivar_query_val generated above
addBety(cultivar_query_val)

```

Add new citations using `getParamQuery` and `addBety`

```{r add-new-citation}

#column names of citations table in bety
citation_cols <- c('author',
                   'year',
                   'title',
                   'journal',
                   'volume',
                   'page',
                   'url',
                   'pdf',
                   'doi')

## run getParamQuery on each row of citations
citation_query_val <- apply(citations,
                            1,
                            getParamQuery,
                            tbl_name = 'citations',
                            tbl_cols = citation_cols)

## run addBety to add new citations # pass in citation_query_val generated above
addBety(citation_query_val)
```

Next: Associate experiments with treatments, experiments with sites, and sites with cultivars

Associations can be made using the `associateBety` function below. 

`param_query` should be a parameterized query that can be used to insert data into one of the following tables in BETY: experiments_sites, experiments_treatments, sites_cultivars, and citations_sites

`associate_col_(1|2|3)` should be the name of the column in the sheet that contains the values to be associated with corresponding positional parameter `($1|$2|$3)`

`associate_col_3` only needs to be used for updating sites_cultivars

```{r associateBety-function}

associateBety <- function(row,
                          tbl_name,
                          param_query,
                          associate_col_1,
                          associate_col_2,
                          associate_col_3 = NULL){
  tryCatch({
    dbBegin(dbcon)
    if(tbl_name %in% c('experiments_sites', 'experiments_treatments')){
      send <- dbSendStatement(dbcon,
                              param_query,
                              params = list(row[[associate_col_1]],
                                            row[[associate_col_2]]))
    }else if(tbl_name  == 'sites_cultivars'){
      send <- dbSendStatement(dbcon,
                              param_query,
                              params = list(row[[associate_col_1]],
                                            row[[associate_col_2]],
                                            row[[associate_col_3]]))
    }
    row_affect <- dbGetRowsAffected(send)
    dbClearResult(send)
    ifelse(row_affect == 1, dbCommit(dbcon), dbRollback(dbcon))
  }, error = function(cond){
    dbRollback(dbcon)
    print(paste0('Error: ', cond))
    print('... Rollback')
  })
}

```

Associate experiments with sites

```{r associate-exp-sites}

## create parameterized query to insert data into experiments_sites table
exp_sites_query <- paste0("insert into experiments_sites ",
                          "(experiment_id, site_id) ",
                          "values (",
                          "(select id from experiments where name = $1), ",
                          "(select id from sites where sitename = $2))")

## run associateBety on each row of sites 
## each row of sites contains a sitename and an associated experiment name
apply(sites[1:2, ],
      1,
      associateBety,
      tbl_name = 'experiments_sites',
      param_query = exp_sites_query,
      associate_col_1 = 'experiment',
      associate_col_2 = 'sitename')

```

Associate experiments with treatments

```{r associate-exp-treat}

## create an expanded grid if at least one treatment is associated with more than one experiment
## asked users to separate experiment names with commas in treatments sheet
# if a treatment is associate with more than one experiment
## if all treatments are associated with a single experiment, use original 
if(length(grep(', ', treatments$experiment)) != 0){
  treatments_updated <- c() ## for loop will add new rows 
  for(i in 1:nrow(treatments)){
    if(grep(', ', treatments$experiment[i]) == 1){
      all_exps <- strsplit(treatments$experiment[i], ', ')[[1]]
      treatments_updated <- rbind(treatments_updated,
                                  expand.grid(name = treatments$name[i],
                                              definition = treatments$definition[i],
                                              control = treatments$control[i],
                                              experiment = all_exps))
    }else{
      treatments_updated <- rbind(treatments_updated,
                                  treatments[i, ])
    }
  }
}else{
  treatments_updated <- treatments
}

## create parameterized query to insert data into experiments_treatments table
exp_treat_query <- paste0("insert into experiments_treatments ",
                          "(experiment_id, treatment_id) ",
                          "values (",
                          "(select id from experiments where name = $1), ",
                          "(select id from treatments where name = $2))")    

## run associateBety on each row of treatments_updated 
## each row of treatments_updated contains a treatment name and an associated experiment name
apply(treatments_updated,
      1,
      associateBety,
      tbl_name = 'experiments_treatments',
      param_query = exp_treat_query,
      associate_col_1 = 'experiment',
      associate_col_2 = 'name')

```

Associate sites with cultivars

```{r associate-sites-cultivars}

## create parameterized query to insert data into sites_cultivars table
sites_cultivars_query <- paste0("insert into sites_cultivars ",
                                "(site_id, cultivar_id) ",
                                "values (",
                                "(select id from sites where sitename = $1), ",
                                "(select id from cultivars where name = $2 and specie_id = $3))")

## run associateBety on each row of sites
## each row of sites contains a sitename and an associated cultivar name and specie id
apply(sites[1:2, ],
      1,
      associateBety,
      tbl_name = 'sites_cultivars',
      param_query = sites_cultivars_query,
      associate_col_1 = 'sitename',
      associate_col_2 = 'cultivar', 
      associate_col_3 = 'specie_id')

```

Next: Associate citation with sites

Associate citation with sites

Do not need to use the `associateBety` function above since all sites are associated with a single citation

```{r associate-citation-site}

author <- citations$author
year <- citations$year
title <- citations$title

for(i in 1:nrow(sites[1:2, ])){
  sitename <- sites$sitename[i]
  citation_site_query <- paste0("insert into citations_sites ",
                                "(citation_id, site_id) ",
                                "values (",
                                "(select id from citations where author = '",
                                author, 
                                "' and year = ",
                                year, 
                                " and title = '",
                                title, 
                                "'), ",
                                "(select id from sites where sitename = '",
                                sitename,
                                "'))")
  tryCatch({
    dbBegin(dbcon)
    send <- dbSendStatement(dbcon,
                          citation_site_query)
    row_affect <- dbGetRowsAffected(send)
    dbClearResult(send)
    ifelse(row_affect == 1, dbCommit(dbcon), dbRollback(dbcon))
  }, error = function(cond){
    dbRollback(dbcon)
    print(paste0('Error: ', cond))
    print('... Rollback')
  })
}

```

Close database connection

```{r disconnect}

dbDisconnect(dbcon)

```
