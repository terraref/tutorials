---
title: "How to upload metadata to BETY"
output: html_document
---

The objective of this tutorial is to demonstrate how to upload a season's metadata to BETY. 
Each season should have metadata for experiments, sites, treatments, cultivars, and citations.
Users will need to copy and fill out the following [google sheets template](https://docs.google.com/spreadsheets/d/1Fr_8xYOucyCQ9WH5_1bfPTMpm3IhKX5oqW4UOMvPoSY/edit#gid=0) and publish to the web.
Instructions on how to fill out the template can be found under the README.
Note: Database connection parameters should also be filled out in the template under the 'db_connection' sheet.

Set up
```{r set-up}

## user will need to pass in arguments at command line 
# args[1] : dbname "bety"
# args[2] : password "bety"
# args[3] : host "localhost"
# args[4] : user "bety"
# args[5] : port 5432
# args[6] : google sheet URL #https://docs.google.com/spreadsheets/d/1c_5j7q3TO6gQ24KSopE-_LXA5HhfsUEqMupckGZAbo8/edit#gid=0

args <- commandArgs(trailingOnly = TRUE)

## load in packages
library(RPostgres)
library(readxl)
library(dplyr)

## disable scientific notation
options(scipen = 999)

## create database connection
dbcon <- dbConnect(RPostgres::Postgres(),
                   dbname = args[1],
                   password = args[2],
                   host = args[3],
                   user = args[4],
                   port = args[5])

```

Use URL provided by user to download complete metadata excel workbook 

```{r download-excel}

meta_file <- 'complete_metadata.xlsx'
download.file(args[6], 
              meta_file) 

## users sheet
users <- read_excel(meta_file, 
                    sheet = 'users')

## experiments sheet
experiments <- read_excel(meta_file, 
                          sheet = 'experiments')

## sites sheet
sites <- read_excel(meta_file, 
                    sheet = 'sites')

## treatments sheet
treatments <- read_excel(meta_file,
                         sheet = 'treatments')

## cultivars sheet
cultivars <- read_excel(meta_file,
                        sheet = 'cultivars')

## citations sheet
citations <- read_excel(meta_file,
                        sheet = 'citations')

###########################################
## change format of experiments$start_date, experiments$end_date to date (yyyy-mm-dd)
experiments$start_date <- as.Date(experiments$start_date)
experiments$end_date <- as.Date(experiments$end_date)

```

Get bety user id from user login

```{r get-user-id}

## get login from 'users' sheet
user_login <- users$login

## reference bety users table
users_bety <- tbl(dbcon,
                  'users')

## get user id
user_id <- users_bety %>%
  filter(login == user_login) %>% 
  select(id) %>% collect

## add user id field to experiments 
experiments$user_id <- rep(user_id$id, 
                           nrow(experiments))

```

Next: Add new experiments, sites, treatments, cultivars, and citations to BETY.

New additions will be added using parameterized queries. 

The following function, `getParamQuery`, can be used to generate a list that contains a parameterized query and set of corresponding parameter values for a row of (experiments|sites|treatments|cultivars|citations)

`getParamQuery` should be run on each row of (experiments|sites|treatments|cultivars|citations) 

```{r getParamQuery-function}

getParamQuery <- function(row, tbl_name, tbl_cols){
  complete_field <- names(row)[which(!is.na(row))] 
  complete_field_table <- complete_field[complete_field %in% tbl_cols]
  position_params <- sapply(1:length(complete_field_table),
                            function(x) paste0('$', x))
  sql_insert <- paste0("insert into ",
                       tbl_name,
                       " (",
                       paste(complete_field_table,
                             collapse = ', '),
                       ") ",
                       "values (",
                       paste(position_params,
                             collapse = ', '),
                       ")")
  param_vals <- as.list(row[complete_field_table])
  return(list(sql_insert = sql_insert,
              param_vals = param_vals))
}

```

Use the `addBety` function to insert new experiments, sites, treatments, cultivars, or citations into BETY. 

The input of `addBety` should be a list containing all parameterized queries and corresponding parameter values for all new experiments, sites, treatments, cultivars, or citations. This list can be generated by running `getParamQuery` on each row of (experiments|sites|treatments|cultivars|citations) using `apply`. See below for more detail. 

```{r addBety-function}

addBety <- function(query_val_list){
  for(i in 1:length(query_val_list)){
    tryCatch({
      dbBegin(dbcon)
      send <- dbSendStatement(dbcon,
                              query_val_list[[i]]$sql_insert,
                              params = unname(query_val_list[[i]]$param_vals))
      row_affect <- dbGetRowsAffected(send)
      dbClearResult(send)
      ifelse(row_affect == 1, dbCommit(dbcon), dbRollback(dbcon))
    }, error = function(cond){
      dbRollback(dbcon)
      print(paste0('Error: ', cond))
      print('... Rollback')
    })
  }
}

```

Add new experiments using `getParamQuery` and `addBety`

```{r add-new-exp}

## column names of experiments table in bety # will be passed into getParamQuery
exp_cols <- c('name',
              'start_date',
              'end_date',
              'description',
              'design',
              'user_id')

## run getParamQuery on each row of experiments  
exp_query_val <- apply(experiments,
                       1,
                       getParamQuery,
                       tbl_name = 'experiments',
                       tbl_cols = exp_cols)

## run addBety to add new experiments # pass in exp_query_val generated above
addBety(exp_query_val)
```

Add new sites using `getParamQuery` and `addBety`

```{r add-new-sites}

#column names of sites table in bety
sites_cols <- c('sitename',
                'city',
                'state',
                'country',
                'notes',
                'greenhouse',
                'geometry',
                'time_zone')

## run getParamQuery on each row of sites 
sites_query_val <- apply(sites[1:2, ],
                         1,
                         getParamQuery,
                         tbl_name = 'sites',
                         tbl_cols = sites_cols)

## run addBety to add new sites # pass in sites_query_val generated above
addBety(sites_query_val)
```

Add new treatments using `getParamQuery` and `addBety`

```{r add-new-treat}

#column names of treatments table in bety
treat_cols <- c('name',
                'definition',
                'control')

## run getParamQuery on each row of treatments 
treat_query_val <- apply(treatments,
                         1,
                         getParamQuery,
                         tbl_name = 'treatments',
                         tbl_cols = treat_cols)

## run addBety to add new treatments # pass in treat_query_val generated above
addBety(treat_query_val)
```

Add new cultivars using `getParamQuery` and `addBety`

```{r add-new-cultivar}

## refer to bety species table to get id from species name 
species_bety <- tbl(dbcon,
                    "species")

## get unique species from cultivars sheet
unq_species <- unique(cultivars$species)

spp_id <- species_bety %>%
  filter(scientificname == unq_species) %>%
  select(id) %>%
  collect()
  
## create specie_id column in cultivars 
cultivars$specie_id <- rep(spp_id$id,
                           nrow(cultivars))

## create specie_id column in sites as well
## (will use later for associating sites with cultivars)
sites$specie_id <- rep(spp_id$id,
                       nrow(sites))

#subset cultivars to only contain name and specie_id combinations not yet present in BETY
cultivars_bety <- tbl(dbcon,
                      "cultivars")

cultivars_bety_sub <- cultivars_bety %>%
  select(name, specie_id) %>%
  collect()

cultivars_new <- anti_join(cultivars, 
                           cultivars_bety_sub,
                           by = c('name', 'specie_id'))

#column names of cultivars table in bety
cultivar_cols <- c('specie_id',
                'name',
                'ecotype',
                'notes')

## run getParamQuery on each row of cultivars 
cultivar_query_val <- apply(cultivars_new[1, ],
                            1,
                            getParamQuery,
                            tbl_name = 'cultivars',
                            tbl_cols = cultivar_cols)

## run addBety to add new cultivars # pass in cultivar_query_val generated above
addBety(cultivar_query_val)

```

Add new citations using `getParamQuery` and `addBety`

```{r add-new-citation}

#column names of citations table in bety
citation_cols <- c('author',
                   'year',
                   'title',
                   'journal',
                   'volume',
                   'page',
                   'url',
                   'pdf',
                   'doi')

## run getParamQuery on each row of citations
citation_query_val <- apply(citations,
                            1,
                            getParamQuery,
                            tbl_name = 'citations',
                            tbl_cols = citation_cols)

## run addBety to add new citations # pass in citation_query_val generated above
addBety(citation_query_val)
```

Next: Associate experiments with treatments, experiments with sites, and sites with cultivars

Associations can be made using the `associateBety` function below. 

`param_query` should be a parameterized query that can be used to insert data into one of the following tables in BETY: experiments_sites, experiments_treatments, sites_cultivars, and citations_sites

`associate_col_(1|2|3)` should be the name of the column in the sheet that contains the values to be associated with corresponding positional parameter `($1|$2|$3)`

`associate_col_3` only needs to be used for updating sites_cultivars

```{r associateBety-function}

associateBety <- function(row,
                          tbl_name,
                          param_query,
                          associate_col_1,
                          associate_col_2,
                          associate_col_3 = NULL){
  tryCatch({
    dbBegin(dbcon)
    if(tbl_name %in% c('experiments_sites', 'experiments_treatments')){
      send <- dbSendStatement(dbcon,
                              param_query,
                              params = list(row[[associate_col_1]],
                                            row[[associate_col_2]]))
    }else if(tbl_name  == 'sites_cultivars'){
      send <- dbSendStatement(dbcon,
                              param_query,
                              params = list(row[[associate_col_1]],
                                            row[[associate_col_2]],
                                            row[[associate_col_3]]))
    }
    row_affect <- dbGetRowsAffected(send)
    dbClearResult(send)
    ifelse(row_affect == 1, dbCommit(dbcon), dbRollback(dbcon))
  }, error = function(cond){
    dbRollback(dbcon)
    print(paste0('Error: ', cond))
    print('... Rollback')
  })
}

```

Associate experiments with sites

```{r associate-exp-sites}

## create parameterized query to insert data into experiments_sites table
exp_sites_query <- paste0("insert into experiments_sites ",
                          "(experiment_id, site_id) ",
                          "values (",
                          "(select id from experiments where name = $1), ",
                          "(select id from sites where sitename = $2))")

## run associateBety on each row of sites 
## each row of sites contains a sitename and an associated experiment name
apply(sites[1:2, ],
      1,
      associateBety,
      tbl_name = 'experiments_sites',
      param_query = exp_sites_query,
      associate_col_1 = 'experiment',
      associate_col_2 = 'sitename')

```

Associate experiments with treatments

```{r associate-exp-treat}

## create an expanded grid if at least one treatment is associated with more than one experiment
## asked users to separate experiment names with commas in treatments sheet
# if a treatment is associate with more than one experiment
## if all treatments are associated with a single experiment, use original 
if(length(grep(', ', treatments$experiment)) != 0){
  treatments_updated <- c() ## for loop will add new rows 
  for(i in 1:nrow(treatments)){
    if(grep(', ', treatments$experiment[i]) == 1){
      all_exps <- strsplit(treatments$experiment[i], ', ')[[1]]
      treatments_updated <- rbind(treatments_updated,
                                  expand.grid(name = treatments$name[i],
                                              definition = treatments$definition[i],
                                              control = treatments$control[i],
                                              experiment = all_exps))
    }else{
      treatments_updated <- rbind(treatments_updated,
                                  treatments[i, ])
    }
  }
}else{
  treatments_updated <- treatments
}

## create parameterized query to insert data into experiments_treatments table
exp_treat_query <- paste0("insert into experiments_treatments ",
                          "(experiment_id, treatment_id) ",
                          "values (",
                          "(select id from experiments where name = $1), ",
                          "(select id from treatments where name = $2))")    

## run associateBety on each row of treatments_updated 
## each row of treatments_updated contains a treatment name and an associated experiment name
apply(treatments_updated,
      1,
      associateBety,
      tbl_name = 'experiments_treatments',
      param_query = exp_treat_query,
      associate_col_1 = 'experiment',
      associate_col_2 = 'name')

```

Associate sites with cultivars

```{r associate-sites-cultivars}

## create parameterized query to insert data into sites_cultivars table
sites_cultivars_query <- paste0("insert into sites_cultivars ",
                                "(site_id, cultivar_id) ",
                                "values (",
                                "(select id from sites where sitename = $1), ",
                                "(select id from cultivars where name = $2 and specie_id = $3))")

## run associateBety on each row of sites
## each row of sites contains a sitename and an associated cultivar name and specie id
apply(sites[1:2, ],
      1,
      associateBety,
      tbl_name = 'sites_cultivars',
      param_query = sites_cultivars_query,
      associate_col_1 = 'sitename',
      associate_col_2 = 'cultivar', 
      associate_col_3 = 'specie_id')

```

Next: Associate citation with sites

Associate citation with sites

Do not need to use the `associateBety` function above since all sites are associated with a single citation

```{r associate-citation-site}

author <- citations$author
year <- citations$year
title <- citations$title

for(i in 1:nrow(sites[1:2, ])){
  sitename <- sites$sitename[i]
  citation_site_query <- paste0("insert into citations_sites ",
                                "(citation_id, site_id) ",
                                "values (",
                                "(select id from citations where author = '",
                                author, 
                                "' and year = ",
                                year, 
                                " and title = '",
                                title, 
                                "'), ",
                                "(select id from sites where sitename = '",
                                sitename,
                                "'))")
  tryCatch({
    dbBegin(dbcon)
    send <- dbSendStatement(dbcon,
                          citation_site_query)
    row_affect <- dbGetRowsAffected(send)
    dbClearResult(send)
    ifelse(row_affect == 1, dbCommit(dbcon), dbRollback(dbcon))
  }, error = function(cond){
    dbRollback(dbcon)
    print(paste0('Error: ', cond))
    print('... Rollback')
  })
}

```

Close database connection

```{r disconnect}

dbDisconnect(dbcon)

```
