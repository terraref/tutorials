# Accessing trait data in R 

## Objective: To be able to use the R traits package to query trait data

This vignette will demonstrate to users how to query TERRA REF trait data using the traits package. 
Users will be shown an example of how to query and visualize season 6 canopy height data as well as how to create a visual summary of a season's available traits and methods.

## Getting Started

First, you will need to install and load the traits package from github.
You will also need to load in other packages that we will be used.

```{r traits-vig-pack, message = FALSE, results = FALSE}

devtools::install_github('terraref/traits', force = TRUE)
library(traits)
library(ggplot2)
library(lubridate)
library(dplyr)

```

## How to query trait data

### Setting options

The function that you will be using to perform your queries is `betydb_query`.
Options can be set to reduce the number of arguments that need to be passed into the function.

```{r traits-vig-bety-opt}

options(betydb_url = "https://terraref.ncsa.illinois.edu/bety/",
        betydb_api_version = 'v1')

```

### An example: Season 6 canopy height data

The following is an example of how to query season 6 canopy height data. 

```{r traits-vig-canopy-query, message = FALSE}

canopy_height <- betydb_query(table     = "search", 
                              trait     = "canopy_height", 
                              sitename  = "~Season 6",
                              limit     =  "none")


```

### Time series of canopy height

Here is an example of how to visualize the data that we just queried. 

```{r traits-vig-canopy-plot, warning = FALSE, message = FALSE, results = FALSE}

#plot a time series of canopy height 
ggplot(data = canopy_height,
       aes(x = lubridate::yday(lubridate::ymd_hms(raw_date)), y = mean)) +
  geom_point(size = 0.5, position = position_jitter(width = 0.1)) +
  xlab("Day of Year") + ylab("Plant Height") +
  guides(color = guide_legend(title = 'Genotype')) +
  theme_bw()

```

## Season Summary

The TERRA REF database contains trait data for many other seasons.
The following chunk of code can be used to get a visual summary of available traits and methods of measurement for a season.
Season 4 will be used as an example.

```{r traits-vig-s4-summary, message = FALSE, echo = TRUE}

#get all of season 4 data 
season_4 <- betydb_query(table     = "search",
                         sitename  = "~Season 4",
                         limit     =  "none")

#update the values of the date column
season_4_update <- season_4 %>% mutate(date = ymd_hms(raw_date))

#create facet wrap
ggplot(data = season_4_update) +
  geom_point(aes(date, mean, color = method_name)) +
  geom_line(aes(date, mean, group = cultivar, color = method_name)) +
  facet_wrap(~trait, ncol = 1)


```
